<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFFiNE æ”¯ä»˜å®æ²™ç®±æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .qr-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
            text-align: center;
        }
        
        .qr-code {
            margin: 20px 0;
        }
        
        .status-section {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ AFFiNE æ”¯ä»˜å®æ²™ç®±æµ‹è¯•</h1>
            <p>æµ‹è¯•æ”¯ä»˜å®æ²™ç®±ç¯å¢ƒçš„å®Œæ•´æ”¯ä»˜æµç¨‹</p>
        </div>
        
        <div class="content">
            <div class="form-section">
                <h2>ğŸ“ è®¢å•ä¿¡æ¯</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="planType">è®¢é˜…ç±»å‹</label>
                        <select id="planType">
                            <option value="pro_monthly">Pro æœˆåº¦è®¢é˜… (Â¥29.00)</option>
                            <option value="pro_yearly">Pro å¹´åº¦è®¢é˜… (Â¥290.00)</option>
                            <option value="team_monthly">å›¢é˜Ÿæœˆåº¦è®¢é˜… (Â¥99.00)</option>
                            <option value="test_small">æµ‹è¯•å°é¢ (Â¥0.01)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">æ”¯ä»˜æ–¹å¼</label>
                        <select id="paymentMethod">
                            <option value="alipay">æ”¯ä»˜å®</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="subject">è®¢å•æ ‡é¢˜</label>
                        <input type="text" id="subject" value="AFFiNE Proè®¢é˜…æœåŠ¡" />
                    </div>
                    <div class="form-group">
                        <label for="userId">ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="userId" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">è®¢å•æè¿°</label>
                    <textarea id="description" rows="3">AFFiNE ProåŠŸèƒ½è®¢é˜…ï¼ŒåŒ…å«é«˜çº§åä½œåŠŸèƒ½å’Œæ— é™å­˜å‚¨ç©ºé—´</textarea>
                </div>
            </div>
            
            <div class="form-section">
                <h2>ğŸ¯ æ“ä½œ</h2>
                <button class="btn" onclick="createPayment()">åˆ›å»ºæ”¯ä»˜è®¢å•</button>
                <button class="btn btn-secondary" onclick="queryStatus()" id="queryBtn" disabled>æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>å¤„ç†ä¸­...</div>
            </div>
            
            <div class="qr-section" id="qrSection">
                <h3>ğŸ“± æ‰«ç æ”¯ä»˜</h3>
                <div class="qr-code" id="qrCode"></div>
                <div id="orderInfo"></div>
                <p>è¯·ä½¿ç”¨æ”¯ä»˜å®æ²™ç®±é’±åŒ…æ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</p>
            </div>
            
            <div class="status-section" id="statusSection" style="display: none;">
                <div id="statusContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script>
        let currentOrderId = null;
        let statusInterval = null;
        
        // é‡‘é¢æ˜ å°„
        const amountMap = {
            'pro_monthly': 2900,    // 29.00å…ƒ
            'pro_yearly': 29000,    // 290.00å…ƒ
            'team_monthly': 9900,   // 99.00å…ƒ
            'test_small': 1         // 0.01å…ƒ
        };
        
        // ç¡®ä¿QRCodeåº“å·²åŠ è½½
        function ensureQRCodeLoaded() {
            return new Promise((resolve, reject) => {
                if (typeof QRCode !== 'undefined') {
                    resolve();
                    return;
                }
                
                // å¦‚æœQRCodeæœªå®šä¹‰ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
                script.onload = () => {
                    if (typeof QRCode !== 'undefined') {
                        resolve();
                    } else {
                        reject(new Error('QRCode library failed to load'));
                    }
                };
                script.onerror = () => reject(new Error('Failed to load QRCode library'));
                document.head.appendChild(script);
            });
        }
        
        async function createPayment() {
            const planType = document.getElementById('planType').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const subject = document.getElementById('subject').value;
            const description = document.getElementById('description').value;
            const userId = document.getElementById('userId').value;
            
            const request = {
                planType: planType,
                amount: amountMap[planType],
                paymentMethod: paymentMethod,
                subject: subject,
                description: description,
                userId: userId || null
            };
            
            showLoading(true);
            hideStatus();
            
            try {
                const response = await fetch('/payment/test/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentOrderId = result.orderId;
                    showQRCode(result);
                    document.getElementById('queryBtn').disabled = false;
                    startStatusPolling();
                } else {
                    showStatus('failed', 'åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥:', error);
                showStatus('failed', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function showQRCode(result) {
            const qrSection = document.getElementById('qrSection');
            const qrCode = document.getElementById('qrCode');
            const orderInfo = document.getElementById('orderInfo');
            
            // æ¸…ç©ºäºŒç»´ç åŒºåŸŸ
            qrCode.innerHTML = '';
            
            // ç”ŸæˆäºŒç»´ç  - ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if (result.qrCodeUrl || result.payData) {
                const qrData = result.qrCodeUrl || result.payData;
                
                // å°è¯•ä½¿ç”¨QRCodeåº“ç”ŸæˆäºŒç»´ç 
                ensureQRCodeLoaded().then(() => {
                    QRCode.toCanvas(qrData, { width: 200, margin: 2 }, (error, canvas) => {
                        if (error) {
                            console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                            showFallbackQRCode(qrData, qrCode);
                        } else {
                            qrCode.appendChild(canvas);
                        }
                    });
                }).catch((error) => {
                    console.error('QRCodeåº“åŠ è½½å¤±è´¥:', error);
                    showFallbackQRCode(qrData, qrCode);
                });
            }
            
            // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
            orderInfo.innerHTML = `
                <div style="margin-top: 15px; text-align: left; display: inline-block;">
                    <p><strong>è®¢å•å·:</strong> ${result.orderId}</p>
                    <p><strong>é‡‘é¢:</strong> Â¥${(result.amount / 100).toFixed(2)}</p>
                    <p><strong>çŠ¶æ€:</strong> <span class="status-${result.status.toLowerCase()}">${getStatusText(result.status)}</span></p>
                </div>
            `;
            
            qrSection.style.display = 'block';
        }
        
        // å¤‡ç”¨äºŒç»´ç æ˜¾ç¤ºæ–¹æ¡ˆ
        function showFallbackQRCode(qrData, container) {
            // ä½¿ç”¨åœ¨çº¿äºŒç»´ç ç”ŸæˆæœåŠ¡ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;
            const img = document.createElement('img');
            img.src = qrUrl;
            img.alt = 'æ”¯ä»˜äºŒç»´ç ';
            img.style.width = '200px';
            img.style.height = '200px';
            img.onerror = () => {
                // å¦‚æœåœ¨çº¿æœåŠ¡ä¹Ÿå¤±è´¥ï¼Œæ˜¾ç¤ºæ–‡æœ¬ä¿¡æ¯
                container.innerHTML = `
                    <div style="border: 2px dashed #ccc; padding: 20px; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 12px; color: #666;">
                        <div>
                            <p>äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>
                            <p style="margin-top: 10px; word-break: break-all; font-size: 10px;">${qrData}</p>
                            <p style="margin-top: 10px; color: #999;">è¯·æ‰‹åŠ¨å¤åˆ¶ä¸Šæ–¹é“¾æ¥åˆ°æ”¯ä»˜å®</p>
                        </div>
                    </div>
                `;
            };
            container.appendChild(img);
        }
        
        async function queryStatus() {
            if (!currentOrderId) {
                alert('è¯·å…ˆåˆ›å»ºæ”¯ä»˜è®¢å•');
                return;
            }
            
            try {
                const response = await fetch(`/payment/test/status/${currentOrderId}`);
                const status = await response.text();
                const statusText = getStatusText(status.replace(/"/g, ''));
                
                showStatus(status.toLowerCase().replace(/"/g, ''), `å½“å‰æ”¯ä»˜çŠ¶æ€: ${statusText}`);
                
                if (status.includes('SUCCESS')) {
                    stopStatusPolling();
                    showStatus('success', 'ğŸ‰ æ”¯ä»˜æˆåŠŸï¼è®¢å•å·²å®Œæˆ');
                }
            } catch (error) {
                console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
                showStatus('failed', 'æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }
        
        function startStatusPolling() {
            // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡çŠ¶æ€
            statusInterval = setInterval(queryStatus, 3000);
        }
        
        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showStatus(type, message) {
            const statusSection = document.getElementById('statusSection');
            const statusContent = document.getElementById('statusContent');
            
            statusSection.className = `status-section status-${type}`;
            statusContent.innerHTML = message;
            statusSection.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('statusSection').style.display = 'none';
        }
        
        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…æ”¯ä»˜',
                'PROCESSING': 'æ”¯ä»˜ä¸­',
                'SUCCESS': 'æ”¯ä»˜æˆåŠŸ',
                'FAILED': 'æ”¯ä»˜å¤±è´¥',
                'CANCELLED': 'å·²å–æ¶ˆ',
                'REFUNDED': 'å·²é€€æ¬¾',
                'UNKNOWN': 'æœªçŸ¥çŠ¶æ€'
            };
            return statusMap[status] || status;
        }
        
        // é¡µé¢å¸è½½æ—¶åœæ­¢è½®è¯¢
        window.addEventListener('beforeunload', stopStatusPolling);
    </script>
</body>
</html>