# ===================================================================
# AFFiNE Java Backend Configuration
# ===================================================================

# Spring 应用配置
spring.application.name=yunke-java-backend
spring.profiles.active=@spring.profiles.active@

# 服务器配置
server.port=8080
server.servlet.context-path=
server.error.whitelabel.enabled=false

# 文件上传配置
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=5MB
spring.servlet.multipart.max-request-size=10MB
spring.servlet.multipart.location=temp

# ===================================================================
# AFFiNE 自定义配置
# ===================================================================

# 服务器配置
affine.server.host=localhost
affine.server.port=8080
affine.server.external-url=http://localhost:8080
affine.server.https-enabled=false
affine.server.flavor=ALLINONE
affine.server.deployment=SELFHOSTED

# 数据库配置 - MySQL
affine.database.url=jdbc:mysql://localhost:3306/affine?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=UTC
affine.database.username=root
affine.database.password=root
affine.database.driver=com.mysql.cj.jdbc.Driver
affine.database.max-pool-size=20
affine.database.min-pool-size=5
affine.database.show-sql=false
affine.database.format-sql=false

# Redis 配置
affine.redis.host=localhost
affine.redis.port=6379
affine.redis.database=0
affine.redis.timeout=3000
affine.redis.max-active=8
affine.redis.max-idle=8
affine.redis.min-idle=2

# 存储配置
# 可选值: LOCAL, S3, R2, COS
affine.storage.provider=${STORAGE_PROVIDER:LOCAL}

# 本地存储配置
affine.storage.local-path=${STORAGE_LOCAL_PATH:./storage}

# 服务器存储配置（Linux生产环境）
affine.storage.server-path=${STORAGE_SERVER_PATH:/opt/affine/storage}
affine.storage.temp-path=${STORAGE_TEMP_PATH:/tmp/affine-uploads}

# 云存储配置（S3/R2/COS）
affine.storage.bucket=${STORAGE_BUCKET:}
affine.storage.region=${STORAGE_REGION:}
affine.storage.access-key-id=${STORAGE_ACCESS_KEY_ID:}
affine.storage.secret-access-key=${STORAGE_SECRET_ACCESS_KEY:}
affine.storage.endpoint=${STORAGE_ENDPOINT:}
affine.storage.public-url-prefix=${STORAGE_PUBLIC_URL_PREFIX:}

# Socket.IO 配置
socketio.server.host=0.0.0.0
socketio.server.port=9092
socketio.server.bossCount=1
socketio.server.workCount=100
socketio.server.allowCustomRequests=true
socketio.server.upgradeTimeout=10000
socketio.server.pingTimeout=60000
socketio.server.pingInterval=25000

# ===================================================================
# AFFiNE 文档同步配置 - 完全参考AFFiNE架构
# ===================================================================

# 文档存储配置
affine.doc.history.maxAge=30
affine.doc.history.minInterval=3600000
affine.doc.update.batchSize=10
affine.doc.merge.delay=5000
affine.doc.cleanup.enabled=true
affine.doc.cleanup.interval=3600000

# YJS 配置
affine.yjs.enabled=true
affine.yjs.compression=true
affine.yjs.merge.strategy=ASYNC

# 同步配置
affine.sync.realtime.enabled=true
affine.sync.broadcast.enabled=true
affine.sync.persistence.enabled=true
affine.sync.conflict.resolution=LATEST_WINS

# AI 配置 - DeepSeek
affine.copilot.enabled=true
affine.copilot.openai.enabled=true
affine.copilot.openai.api-key=sk-1836f621956b48d8bc46f62d2b4a9bb3
affine.copilot.openai.model=deepseek-chat
affine.copilot.openai.base-url=https://api.deepseek.com/v1

# 支付配置
affine.payment.enabled=false
affine.payment.stripe.secret-key=${STRIPE_SECRET_KEY:}
affine.payment.stripe.webhook-secret=${STRIPE_WEBHOOK_SECRET:}

# 认证配置
affine.auth.jwt.secret=${JWT_SECRET:affine_jwt_secret_key_please_change_in_production}
affine.auth.jwt.expiration=604800000
affine.auth.session.max-age=604800000
affine.auth.session.cookie-name=affine-session

# OAuth 配置
affine.auth.oauth.google.enabled=false
affine.auth.oauth.google.client-id=${GOOGLE_CLIENT_ID:}
affine.auth.oauth.google.client-secret=${GOOGLE_CLIENT_SECRET:}

affine.auth.oauth.github.enabled=false
affine.auth.oauth.github.client-id=${GITHUB_CLIENT_ID:}
affine.auth.oauth.github.client-secret=${GITHUB_CLIENT_SECRET:}

# 通知配置
affine.notification.email.enabled=false
affine.notification.email.host=${MAIL_HOST:}
affine.notification.email.port=587
affine.notification.email.username=${MAIL_USERNAME:}
affine.notification.email.password=${MAIL_PASSWORD:}
affine.notification.email.from=${MAIL_FROM:noreply@affine.pro}

# ===================================================================
# Spring Framework 配置
# ===================================================================

# 数据源配置
spring.datasource.url=${affine.database.url}
spring.datasource.username=${affine.database.username}
spring.datasource.password=${affine.database.password}
spring.datasource.driver-class-name=${affine.database.driver}

# JPA 配置
spring.jpa.hibernate.ddl-auto=update
spring.jpa.open-in-view=false
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.hbm2ddl.auto=update

# Redis 配置
spring.data.redis.host=${affine.redis.host}
spring.data.redis.port=${affine.redis.port}
spring.data.redis.database=${affine.redis.database}
spring.data.redis.timeout=${affine.redis.timeout}

# 缓存配置
spring.cache.type=redis
spring.cache.redis.time-to-live=3600000
spring.cache.redis.cache-null-values=true
spring.cache.redis.use-key-prefix=true

# Flyway 配置 - 开发阶段暂时禁用
spring.flyway.enabled=false
# spring.flyway.baseline-on-migrate=true
# spring.flyway.locations=classpath:db/migration
# spring.flyway.sql-migration-prefix=V
# spring.flyway.sql-migration-suffix=.sql


# Web 配置
spring.mvc.throw-exception-if-no-handler-found=true
# 启用静态资源映射以支持文件上传访问
spring.web.resources.add-mappings=true

# JSON 配置
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.time-zone=UTC
spring.jackson.default-property-inclusion=non_null

# 文件上传配置
spring.servlet.multipart.max-file-size=100MB
spring.servlet.multipart.max-request-size=100MB

# Actuator 配置
management.endpoints.web.exposure.include=health,info,metrics,prometheus,heapdump,threaddump
management.endpoint.health.show-details=when_authorized
management.endpoint.health.show-components=always
management.endpoint.health.probes.enabled=true
management.endpoint.info.enabled=true
management.endpoint.metrics.enabled=true
management.endpoint.prometheus.enabled=true
management.health.defaults.enabled=true
management.health.db.enabled=true
management.health.redis.enabled=true
management.health.diskspace.enabled=true
management.health.ping.enabled=true
management.metrics.export.prometheus.enabled=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.percentiles.http.server.requests=0.5,0.95,0.99
management.metrics.web.server.request.autotime.enabled=true

# ===================================================================
# 日志配置 - 开启详细调试模式
# ===================================================================

# 根日志级别 - 设置为INFO以显示详细信息
logging.level.root=INFO

# 应用日志级别 - 设置为INFO以显示所有调试日志
logging.level.com.yunke=INFO

# 关键服务的详细日志 - 显示我们的调试日志
logging.level.com.yunke.backend.service.impl.WorkspaceDocServiceImpl=INFO
logging.level.com.yunke.backend.service.SpaceSyncGateway=INFO
logging.level.com.yunke.backend.modules.document.api.WorkspaceDocController=INFO
logging.level.com.yunke.backend.controller.DatabaseValidationController=INFO

# 数据库相关日志 - 显示SQL和参数
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
logging.level.org.springframework.jdbc.core=DEBUG

# 保持其他组件的日志级别较低以减少噪音
logging.level.org.springframework.security=WARN
logging.level.org.springframework.web=WARN
logging.level.org.springframework.web.servlet=WARN
logging.level.org.springframework.http.converter=WARN
logging.level.org.springframework.data.redis=WARN
logging.level.com.corundumstudio.socketio=WARN
logging.level.org.springframework.transaction=WARN
logging.level.com.yunke.backend.security.JwtAuthenticationFilter=WARN

# 设置控制台日志格式，包含更多信息
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{50} - %msg%n

# Thymeleaf 配置 - 禁用模板位置检查（我们不使用Thymeleaf）
spring.thymeleaf.check-template-location=false
# logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId},%X{spanId}] %logger{36} - %msg%n
# logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId},%X{spanId}] %logger{36} - %msg%n

# 日志文件配置 (通过 logback-spring.xml 配置)
# logging.file.name=logs/affine-backend.log
# logging.logback.rollingpolicy.max-file-size=100MB
# logging.logback.rollingpolicy.total-size-cap=1GB
# logging.logback.rollingpolicy.max-history=30
